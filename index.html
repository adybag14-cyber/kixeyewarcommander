<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>War Commander</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }

        #game-holder {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
    </style>
</head>

<body>
    <div id="game-holder"></div>

    <script>
        window.wc_config = {
            "userid": "123456",
            "username": "LocalCommander",
            "currenttime": 1766425592,
            "version": "71601",
            "map_id": "1",
            "homebase": "500,500",
            "server_list": [{ "id": "1", "name": "Local Server", "ip": "127.0.0.1", "port": 8089 }],
            "flags": { "faction_change_enabled": 1, "building_multimove": 1, "worldmap_enabled": 1 }
        };
        window.bg = { get_version: function () { return "71601"; } };
    </script>

    <script type="text/javascript" src="./js/patch_game_init_v33.js"></script>
    <script src="js/warcommander.patched.js" onload="console.log('[BOOT] warcommander.patched.js script tag loaded')" onerror="console.error('[BOOT] warcommander.patched.js script tag FAILED to load')"></script>
    <script src="asset_preloader.js"></script>

    <script>
        window.onload = function () {
            console.log("[BOOT] window.onload triggered");
            var localOrigin = (window.location && window.location.origin && window.location.origin !== "null")
                ? window.location.origin
                : "http://127.0.0.1:8089";

            function checkEngine() {
                if (window.lime && window.lime.$scripts && window.lime.$scripts.WarCommander) {
                    console.log("[BOOT] WarCommander script detected. Executing wrapper...");
                    try {
                        window.lime.$scripts.WarCommander(window, window);

                        // FORCE PATCHES IMMEDIATELY after classes are defined
                        if (window.applyPatchesNow) {
                            console.log("[BOOT] Triggering immediate patch application...");
                            window.applyPatchesNow();
                        }

                        console.log("[BOOT] Waiting for ApplicationMain and Preloader...");
                        let bootAttempts = 0;
                        let bootInterval = setInterval(function () {
                            bootAttempts++;
                            var App = window._hx_classes ? window._hx_classes["ApplicationMain"] : null;
                            var Preloader = window.AssetPreloader;
                            var AssetsReady = window.__ASSETS_READY__;

                            console.log(`[BOOT] Attempt ${bootAttempts}: App=${!!App}, Preloader=${!!Preloader}, Ready=${AssetsReady}`);

                            if (App && App.create && AssetsReady) {
                                clearInterval(bootInterval);
                                console.log("[BOOT] All systems GO. Calling ApplicationMain.create()...");

                                window.onerror = function (msg, url, line, col, error) {
                                    console.error("[CRASH] Fatal Exception:", msg, "at", url, ":", line);
                                    if (error && error.stack) console.error(error.stack);
                                    return false;
                                };

                                Preloader.injectIntoCache();

                                if (window.applyPatchesNow) window.applyPatchesNow();

                                App.create({
                                    rootPath: "",
                                    element: document.getElementById("game-holder"),
                                    parameters: {
                                        "baseurl": localOrigin + "/assets/",
                                        "apiurl": localOrigin + "/api/",
                                        "wmbasemanurl": localOrigin + "/api/",
                                        "gameurl": localOrigin + "/",
                                        "locale": "en",
                                        "version": "71601"
                                    }
                                });
                            } else if (bootAttempts > 50) {
                                console.error("[BOOT] FAILED: Timeout waiting for App or Assets.");
                                clearInterval(bootInterval);
                            }
                        }, 500);
                    } catch (e) {
                        console.error("[BOOT] EXCEPTION in wrapper:", e);
                    }
                } else {
                    console.log("[BOOT] Waiting for WarCommander script...");
                    setTimeout(checkEngine, 500);
                }
            }

            checkEngine();
        };
    </script>
</body>

</html>
